
	.386
	.model flat,STDCALL

	extrn ExitProcess: proc
	extrn GetLocalTime: proc
	extrn MessageBoxA: proc
	extrn _wsprintfA:Proc

	extrn CreateFileA:Proc, FileTimeToSystemTime:Proc, GetFileTime:Proc, GetOpenFileNameA:Proc
	
	.data
Time_title	db 'Джус 5',0
TIME_STRING	db	2000 dup (0)

FORMAT_STRING:
	db '    Creation Time:',0dh,0ah,0dh,0ah
	db '                 Year: %ld',0dh,0ah
	db '          Month: %ld',0dh,0ah
	db '  DayOfWeek: %ld',0dh,0ah
	db '            Day: %ld',0dh,0ah
	db '          Hour: %ld',0dh,0ah
	db '         Minute: %ld',0dh,0ah
	db 0

Time_struc:
   wYear		dw 0	; Рік
   wMonth	dw 0	; Місяць
   wDayOfWeek	dw 0	; День тиждня
   wDay		dw 0	; Число	
   wHour		dw 0	; Година
   wMinute	dw 0	; Хвилина
   wSecond	dw 0	; Секунда
   wMilliseconds	dw 0	; Мілісекунда


STR_OPENNANE:
 FSize		dd 76	; довжина цiєї структури;
  Howner	dd 0	; вказiвник вiкна-власника або 0;
  AppHWnd	dd 0	; вказiвник модуля-власника;
  Filters		dd offset filter_tab  ; вказiвник на перелiк типiв файлiв;
  CustFilters	dd 0	; вказiвник на перелiк типiв файлiв якi дозволенi користувачевi;
  CstFltSize	dd 0	; довжина буферу на який вказує CustFilters;
  CurFilter	dd 4	; iндекс вибраного фiльтру (1,2,3,...) або 0;
  CurFileName	dd offset openname	; вказiвник на повне iм'я файлу, наприклад, на “С:\dir1\dir2\file.ext”,0;
  CurFlNmSize	dd 512	; довжина буферу вказаного в CurFileName;
  CurFile	dd 0	; вказiвник на iм'я файлу з розширенням;
  CurFlSize	dd 0	; довжина буферу вказаного в CurFile;
  InitialDir	dd offset dir	; вказiвник на каталог файлу або 0 для даного каталога;
  DlgTitle	dd offset titl	; вказiвник на назву вiкна;
  Flags		dd 00h		; тип вiкна, яке вiдкриває файл (може бути 200h);
  FileOffset	dw 0		; повертає довжину повного шляху, наприклад=13 якщо користувач ввів рядок “С:\dir1\dir2\file.asm”;
  ExtOffset	dw 0	; змiщення вiд початку рядка до розширення (в даному прикладi =18) або 0 якщо розширення немає;
  Extension	dd 0	; вказiвник на стандартне розширення, яке буде додано до iменi, якщо розширення немає (або 0);
  CustData	dd 0	; вказiвник на данi для hook-процедури;
  HookProc	dd 0	; вказiвник на hook-процедуру, якщо вона дозволена у Flags;
  TmplateRsc	dd 0	; вказiвник на шаблон ресурсiв, якщо вiн передбачений у Flags;

;                додаткові змінні до структури:
    filter_tab	db "Графiчнi файли (*.BMP)",0h,"*.BMP",0
		db "Текстовi файли (*.TXT)",0,"*.txt",0
		db "Лабораторнi роботи (*.ASM)",0,"*.asm",0
		db "Всi типи файлiв (*.*)",0h,"*.*",0,0
    dir		db "c:\users",0

    titl		db "Лр № 5 Джус",0


;==============================================================
.data?
  hFile	dd ?

CREATION_TIME		dq ?
LAST_ACCESS_TIME	dq ?
LAST_WRITE_TIME		dq ?

openname	db 260 dup(?)

;--------------------------------------------------------------
	.code
Start:
	call GetOpenFileNameA,offset STR_OPENNANE

	push 0
        push 0h          ; файл з довільними атрибутами
        push 4h          ; відкрити існуючий або створити новий
        push 0            ; без атрибутів безпеки
        push 1h          ; дозволено спільний доступ по читанню
        push 80000000h             ; читати файл
        push offset openname	    ; адреса імені файлу
        call CreateFileA
	mov  hFile,eax         ; отримали хендл файлу


	call GetFileTime,hFile,offset CREATION_TIME,offset LAST_ACCESS_TIME,offset LAST_WRITE_TIME

	call FileTimeToSystemTime, offset LAST_WRITE_TIME,offset Time_struc
;------------------------------------------------------------------------
;	push	offset Time_struc
;	call	GetLocalTime

	xor eax,eax		; EAX=0
	mov	ax,wMinute	
	push eax  ; наступні параметри з стеку не забираються
	mov	ax,wHour
	push eax
	mov	ax,wDay
	push eax
	mov	ax,wDayOfWeek
	push eax
	mov 	ax,wMonth
	push eax
	mov	ax,wYear
	push eax
	push offset FORMAT_STRING
	push offset TIME_STRING
	call _wsprintfA		; Вивід параметрів
	add esp,4*8		; та очищення стеку

	push	0h
	push	offset Time_title
	push	offset TIME_STRING
	push	0
	call	MessageBoxA

	push	0
	call	ExitProcess
	
end   Start

